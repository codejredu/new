<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת בקרת מיקרוביט</title>
    <!-- טעינת Tailwind CSS עבור עיצוב מודרני ורספונסיבי -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* הגדרת גופן אינטר ומייקרו-סגנונות */
        body { font-family: "Inter", sans-serif; background-color: #f7f9fc; }
        .led.on { background-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.8); }
        .serial-log { height: 150px; overflow-y: scroll; font-family: monospace; font-size: 0.85rem; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Custom Message Box UI (מחליף את alert()) -->
    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-4 border-indigo-500">
            <h3 id="messageTitle" class="text-xl font-bold mb-3 text-red-600">שגיאה</h3>
            <p id="messageContent" class="text-gray-700 mb-4"></p>
            <button id="closeMessageBox" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">סגור</button>
        </div>
    </div>

    <div class="max-w-xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">בקרת מיקרוביט (Web Console)</h1>
        
        <!-- סעיף 1: שליטה אלחוטית על מטריצת הלדים (Bluetooth) -->
        <div class="mb-8 p-4 border border-blue-200 bg-blue-50 rounded-lg">
            <h2 class="text-xl font-semibold text-blue-800 mb-4 flex items-center justify-between">
                <span>1. שליטה בלדים (Bluetooth)</span>
                <span id="status" class="text-sm font-medium text-red-500 bg-red-100 px-3 py-1 rounded-full">מנותק</span>
            </h2>

            <button id="btConnectBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 disabled:bg-gray-400">
                <svg class="w-5 h-5 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                חבר Micro:bit (בלוטוס)
            </button>
            
            <p class="text-sm text-gray-600 mt-3 text-center">ודא שהמיקרוביט שלך מחובר לחשמל ושהקושחה שלו מוגדרת ל-Bluetooth.</p>

            <!-- רשת הלדים 5x5 -->
            <div class="led-grid grid grid-cols-5 gap-3 mt-6 p-4 bg-gray-100 rounded-lg border border-gray-300">
                <!-- הריבועים ייווצרו על ידי JavaScript -->
            </div>
        </div>

        <!-- סעיף 2: צריבת קובץ HEX (USB) -->
        <div class="mb-8 p-4 border border-green-200 bg-green-50 rounded-lg">
            <h2 class="text-xl font-semibold text-green-800 mb-4">2. הורדת קובץ HEX (USB)</h2>
            <p class="text-sm text-gray-600 mb-4">צריבת קובץ HEX חדש ישירות לכרטיס (פועל על ידי בחירת כונן MICROBIT).</p>
            
            <input type="file" id="hexInput" accept=".hex" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 cursor-pointer mb-4">
            
            <button id="flashBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 disabled:bg-gray-400">
                <svg class="w-5 h-5 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                צרוב לכרטיס (Flash)
            </button>
        </div>
        
        <!-- סעיף 3: חיבור טורי (Serial) -->
        <div class="p-4 border border-purple-200 bg-purple-50 rounded-lg">
            <h2 class="text-xl font-semibold text-purple-800 mb-4 flex items-center justify-between">
                <span>3. תקשורת טורית (Web Serial API)</span>
                <span id="serialStatus" class="text-sm font-medium text-red-500 bg-red-100 px-3 py-1 rounded-full">מנותק</span>
            </h2>

            <button id="serialConnectBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 disabled:bg-gray-400 mb-4">
                <svg class="w-5 h-5 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                חבר USB טורי
            </button>
            
            <div id="serialLog" class="serial-log bg-gray-800 text-green-400 p-2 rounded-lg border border-gray-700 mb-4">
                > המתן לחיבור...
            </div>
            
            <div class="flex space-x-2 rtl:space-x-reverse">
                <input type="text" id="serialInput" placeholder="הקלד פקודה לשליחה (עם רווחים)" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                <button id="serialSendBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50" disabled>שלח</button>
            </div>
        </div>

    </div>

<script>
    // --- הגדרות Bluetooth עבור Micro:bit ---
    let bluetoothDevice;
    let ledCharacteristic;
    const LED_SERVICE_UUID = 'e95dd91d-251d-470a-a062-fa1922dfa9a8';
    const LED_MATRIX_UUID = 'e95d7b77-251d-470a-a062-fa1922dfa9a8';

    // --- הגדרות Serial עבור Web Serial API ---
    let serialPort;
    let serialWriter;
    let serialReader;
    let serialPortIsConnected = false;

    // --- אלמנטים ב-DOM ---
    const btConnectBtn = document.getElementById('btConnectBtn');
    const statusText = document.getElementById('status');
    const gridDiv = document.querySelector('.led-grid');
    const flashBtn = document.getElementById('flashBtn');
    const hexInput = document.getElementById('hexInput');
    const serialConnectBtn = document.getElementById('serialConnectBtn');
    const serialStatus = document.getElementById('serialStatus');
    const serialLog = document.getElementById('serialLog');
    const serialInput = document.getElementById('serialInput');
    const serialSendBtn = document.getElementById('serialSendBtn');

    // מערך שמייצג את מצב 25 הלדים (0=כבוי, 1=דלוק)
    const leds = [];
    
    // --- Custom Message Box Implementation (Replaces alert()) ---
    const messageBox = document.getElementById('messageBox');
    const messageTitle = document.getElementById('messageTitle');
    const messageContent = document.getElementById('messageContent');
    const closeMessageBox = document.getElementById('closeMessageBox');

    // הצגת תיבת ההודעה
    closeMessageBox.addEventListener('click', () => {
        messageBox.classList.add('hidden');
    });

    // פונקציה להצגת הודעה מותאמת אישית
    function showMessage(title, content, isError = true) {
        messageTitle.innerText = title;
        messageContent.innerText = content;
        messageTitle.classList.toggle('text-red-600', isError);
        messageTitle.classList.toggle('text-green-600', !isError);
        messageBox.classList.remove('hidden');
        // הוספת פקודת תצוגה כדי להבטיח שה-Flex יפעל
        messageBox.style.display = 'flex'; 
    }
    
    // --- יצירת רשת הלדים הויזואלית (5x5) ---
    for (let i = 0; i < 25; i++) {
        let div = document.createElement('div');
        div.className = 'led w-full h-full aspect-square bg-gray-300 rounded-lg cursor-pointer transition duration-150 transform hover:scale-105 active:scale-95';
        div.title = `לד מספר ${i + 1}`;
        div.onclick = () => toggleLed(i, div);
        gridDiv.appendChild(div);
        leds.push({ element: div, state: 0 });
    }

    // --- לוגיקת הדלקה/כיבוי לד ---
    function toggleLed(index, element) {
        // שינוי המצב והעיצוב
        leds[index].state = leds[index].state ? 0 : 1;
        element.classList.toggle('on', leds[index].state === 1);

        // שליחה למיקרוביט אם מחובר
        if (ledCharacteristic) {
            sendLedData();
        }
    }

    // --- פונקציה לשליחת נתוני ה-LED דרך Bluetooth ---
    async function sendLedData() {
        if (!ledCharacteristic) return;

        // המרת מערך 25 הלדים ל-5 בתים (אוקטטים) כפי שפרוטוקול ה-Micro:bit דורש.
        let data = new Uint8Array(5);
        for (let row = 0; row < 5; row++) {
            let byte = 0;
            for (let col = 0; col < 5; col++) {
                if (leds[row * 5 + col].state) {
                    // הגדרה: ביט 4 הוא העמודה הראשונה, ביט 0 הוא העמודה החמישית.
                    byte |= (1 << (4 - col));
                }
            }
            data[row] = byte;
        }
        
        try {
            await ledCharacteristic.writeValue(data);
        } catch (error) {
            console.error("שגיאה בשליחת נתוני בלוטוס:", error);
            statusText.innerText = "שגיאה בשליחה";
            statusText.classList.replace('text-green-500', 'text-red-500');
        }
    }

    // --- לוגיקת חיבור Bluetooth ---
    btConnectBtn.addEventListener('click', async () => {
        if (!navigator.bluetooth) {
            showMessage('שגיאת בלוטוס', 'הדפדפן שלך אינו תומך ב-Web Bluetooth. השתמש ב-Chrome או Edge.', true);
            return;
        }
        
        try {
            statusText.innerText = "מנסה להתחבר...";
            statusText.classList.replace('text-red-500', 'text-yellow-500');

            // 1. בקשת התקן
            bluetoothDevice = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'BBC micro:bit' }],
                optionalServices: [LED_SERVICE_UUID]
            });

            // 2. חיבור לשרת ה-GATT
            const server = await bluetoothDevice.gatt.connect();
            
            // 3. קבלת השירות והמאפיין
            const service = await server.getPrimaryService(LED_SERVICE_UUID);
            ledCharacteristic = await service.getCharacteristic(LED_MATRIX_UUID);

            statusText.innerText = "מחובר ל-" + bluetoothDevice.name;
            statusText.classList.replace('text-yellow-500', 'text-green-500');
            
            // הגדרת מאזין לניתוק
            bluetoothDevice.addEventListener('gattserverdisconnected', () => {
                statusText.innerText = "נותק";
                statusText.classList.replace('text-green-500', 'text-red-500');
                ledCharacteristic = null;
                btConnectBtn.disabled = false;
            });
            btConnectBtn.disabled = true;

            // שליחה ראשונית (איפוס לדים)
            sendLedData();

        } catch (error) {
            console.error("שגיאה בתהליך החיבור:", error);
            statusText.innerText = "חיבור נכשל";
            statusText.classList.replace('text-yellow-500', 'text-red-500');
            
            // טיפול ספציפי בשגיאת אבטחה (permissions policy)
            if (error.name === 'SecurityError' || (error.message && error.message.includes("disallowed by permissions policy"))) {
                let errorMessage = "שגיאת הרשאה! הדפדפן חוסם גישה לבלוטוס בסביבה מבודדת זו. אנא: שמור את הקובץ כ-HTML והפעל אותו ישירות בדפדפן (Chrome/Edge) כדי לעבוד עם ה-Micro:bit.";
                showMessage('שגיאת הרשאת בלוטוס', errorMessage, true);
                return; 
            }
        }
    });

    // --- לוגיקת צריבה (Flash) באמצעות File System Access API ---
    flashBtn.addEventListener('click', async () => {
        const file = hexInput.files[0];
        
        if (!file) {
            showMessage('שגיאת קובץ', 'אנא בחר קובץ HEX לפני הצריבה.', true); 
            return;
        }
        
        if (!window.showDirectoryPicker) {
            showMessage('שגיאת דפדפן', 'הדפדפן שלך אינו תומך בגישה ישירה למערכת קבצים. נסה Chrome או Edge.', true);
            return;
        }

        try {
            // הנחיה למשתמש לבחור את כונן המיקרוביט
            showMessage('נא לבחור כונן', 'בחלון שיופיע, אנא בחר את כונן ה-MICROBIT שמופיע במחשב שלך (דרך USB).', false);
            
            const dirHandle = await window.showDirectoryPicker();
            
            // יצירת הקובץ בכונן שנבחר (המכונה 'MICROBIT')
            const fileHandle = await dirHandle.getFileHandle(file.name, { create: true });
            const writable = await fileHandle.createWritable();
            
            // כתיבת תוכן קובץ ה-HEX
            await writable.write(file);
            await writable.close();

            showMessage('צריבה הצליחה', 'הקובץ נשלח בהצלחה! המיקרוביט יאתחל את עצמו ויריץ את הקוד החדש.', false);
            
        } catch (err) {
            console.error("שגיאה בצריבה:", err);
            
            // בדיקה אם היתה שגיאת ביטול משתמש
            if (err.name === 'AbortError') {
                showMessage('צריבה בוטלה', 'הצריבה בוטלה על ידי המשתמש.', false);
            } else {
                showMessage('שגיאת צריבה', 'הצריבה נכשלה. ודא שהמיקרוביט מחובר ושבחרת את הכונן הנכון: ' + err.message, true);
            }
        }
    });

    // --- פונקציות Web Serial API ---

    // פונקציה להוספת שורת Log
    function addToSerialLog(text, incoming = true) {
        const date = new Date().toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        const prefix = incoming ? '<span class="text-yellow-300">&lt; Microbit</span>: ' : '<span class="text-blue-300">&gt; Console</span>: ';
        serialLog.innerHTML += `<div class="break
