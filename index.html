<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×©×œ×™×˜×” ×‘-Micro:bit ×¢× Blockly</title>
    
    <!-- ×˜×¢×™× ×ª ×¡×¤×¨×™×•×ª Blockly ××”-CDN -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/blocks.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript.min.js"></script>
    <script src="https://unpkg.com/blockly/msg/he.js"></script> <!-- ×¢×‘×¨×™×ª -->

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        /* ×¡×¨×’×œ ×›×œ×™× ×¢×œ×™×•×Ÿ */
        .toolbar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 1000px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .status-indicator {
            font-weight: bold;
            color: #dc3545; /* ××“×•× ×›×‘×¨×™×¨×ª ××—×“×œ */
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator.connected {
            color: #28a745; /* ×™×¨×•×§ ×›×©××—×•×‘×¨ */
        }

        /* ×›×¤×ª×•×¨×™× */
        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
        }

        #connectBtn {
            background-color: #007bff;
            color: white;
        }
        #connectBtn:hover { background-color: #0056b3; }
        #connectBtn:disabled { background-color: #ccc; cursor: not-allowed; }

        #runBtn {
            background-color: #28a745;
            color: white;
        }
        #runBtn:hover { background-color: #218838; }
        #runBtn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* ××–×•×¨ ×”-Blockly */
        #blocklyDiv {
            height: 600px;
            width: 90%;
            max-width: 1000px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background: white;
        }

        /* ×”×•×“×¢×ª ××–×”×¨×” ×× ×œ× ×¨×¥ ×‘×©×¨×ª */
        #https-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
            border: 1px solid #ffeeba;
        }
    </style>
</head>
<body>

    <h1>×‘×§×¨ Micro:bit ×•×™×–×•××œ×™</h1>

    <div id="https-warning">
        âš ï¸ ×©×™× ×œ×‘: Web Bluetooth ×¢×•×‘×“ ×¨×§ ×‘-HTTPS ××• ×‘-Localhost (×©×¨×ª ××§×•××™). ×× ×¤×ª×—×ª ××ª ×”×§×•×‘×¥ ×™×©×™×¨×•×ª, ×–×” ×œ× ×™×¢×‘×•×“.
    </div>

    <div class="toolbar">
        <div>
            <button id="connectBtn">ğŸ”Œ ×”×ª×—×‘×¨ ×œ-Micro:bit</button>
            <span id="status" class="status-indicator">ğŸ”´ ×× ×•×ª×§</span>
        </div>
        <div>
            <button id="runBtn" disabled>â–¶ï¸ ×”×¨×¥ ×ª×•×›× ×™×ª</button>
        </div>
    </div>

    <div id="blocklyDiv"></div>

    <!-- ×”×’×“×¨×ª ×”-Toolbox (×¨×©×™××ª ×”×‘×œ×•×§×™× ×‘×¦×“) -->
    <xml id="toolbox" style="display: none">
        <category name="Micro:bit" colour="230">
            <block type="microbit_led"></block>
            <block type="microbit_wait"></block>
        </category>
        <category name="×œ×•×’×™×§×”" colour="210">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <block type="math_number">
                        <field name="NUM">5</field>
                    </block>
                </value>
            </block>
            <block type="controls_if"></block>
        </category>
    </xml>

    <script>
        // ×‘×“×™×§×” ×× ×”×“×¤×“×¤×Ÿ ×ª×•××š ×•×× ×× ×—× ×• ×‘×¡×‘×™×‘×” ×××•×‘×˜×—×ª
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            document.getElementById('https-warning').style.display = 'block';
        }

        // ==========================================
        // 1. ×”×’×“×¨×ª ×‘×œ×•×§×™× ××•×ª×××™× ××™×©×™×ª (Custom Blocks)
        // ==========================================

        // ×‘×œ×•×§: ×”×“×œ×§×ª/×›×™×‘×•×™ ×œ×“
        Blockly.Blocks['microbit_led'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("ğŸ’¡ × ×•×¨×•×ª LED")
                    .appendField(new Blockly.FieldDropdown([["×”×“×œ×§ (×œ×‘)","ON"], ["×›×‘×”","OFF"]]), "STATE");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip("×©×•×œ×— ×¤×§×•×“×” ×œ××™×§×¨×•×‘×™×˜ ×œ×”×¦×™×’ ×¦×•×¨×” ××• ×œ×›×‘×•×ª ××¡×š");
            }
        };

        Blockly.JavaScript['microbit_led'] = function(block) {
            var state = block.getFieldValue('STATE');
            var command = state === 'ON' ? 'LED_ON' : 'LED_OFF';
            // ×©×™××•×© ×‘-await ×›×“×™ ×©×”×¤×§×•×“×•×ª ×™×™×©×œ×—×• ××—×ª ××—×¨×™ ×”×©× ×™×™×” ×•×œ× ×‘××›×” ××—×ª
            return 'await sendCommand("' + command + '");\n';
        };

        // ×‘×œ×•×§: ×”××ª× ×”
        Blockly.Blocks['microbit_wait'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("â³ ×—×›×”")
                    .appendField(new Blockly.FieldTextInput("1"), "SECONDS")
                    .appendField("×©× ×™×•×ª");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip("×××ª×™×Ÿ ×œ×¤× ×™ ×”×¤×§×•×“×” ×”×‘××”");
            }
        };

        Blockly.JavaScript['microbit_wait'] = function(block) {
            var seconds = block.getFieldValue('SECONDS');
            return 'await wait(' + seconds + ');\n';
        };

        // ==========================================
        // 2. ××ª×—×•×œ ×¡×‘×™×‘×ª ×”×¢×‘×•×“×” (Workspace)
        // ==========================================
        
        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            scrollbars: true,
            rtl: true // ×›×™×•×•×Ÿ ××™××™×Ÿ ×œ×©×××œ
        });

        // ==========================================
        // 3. ×œ×•×’×™×§×ª Web Bluetooth
        // ==========================================

        // ×§×‘×•×¢×™× ×©×œ ×©×™×¨×•×ª ×”-UART ×©×œ Nordic
        const UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const UART_TX_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // ×œ×›×ª×™×‘×”

        let bluetoothDevice;
        let uartCharacteristic;

        const connectBtn = document.getElementById('connectBtn');
        const runBtn = document.getElementById('runBtn');
        const statusSpan = document.getElementById('status');

        connectBtn.addEventListener('click', async () => {
            try {
                if (!navigator.bluetooth) {
                    alert('×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘-Web Bluetooth. × × ×œ×”×©×ª××© ×‘-Chrome ××• Edge.');
                    return;
                }

                console.log('××—×¤×© ×”×ª×§×Ÿ Micro:bit...');
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }],
                    optionalServices: [UART_SERVICE_UUID]
                });

                // ×××–×™× ×™× ×œ× ×™×ª×•×§
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

                statusSpan.innerText = 'ğŸŸ¡ ××ª×—×‘×¨...';
                
                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                uartCharacteristic = await service.getCharacteristic(UART_TX_UUID);

                onConnected();

            } catch (error) {
                console.error('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª:', error);
                // ×©×™× ×™×ª×™ ××ª ×”-alert ×œ×”×•×“×¢×” ×™×“×™×“×•×ª×™×ª ×™×•×ª×¨, ×©× ×•×ª× ×ª ×§×•× ×˜×§×¡×˜ ×œ××‘×˜×—×”
                const errorMessage = error.name === 'SecurityError' && error.message.includes('permissions policy') 
                    ? '×©×’×™××ª ××‘×˜×—×” (SecurityError): ×”×’×™×©×” ×œ×‘×œ×•×˜×•×ª\' × ×—×¡××” ×¢×œ ×™×“×™ ××“×™× ×™×•×ª ×”×”×¨×©××•×ª. ×× × ×”×¨×¥ ××ª ×”×™×™×©×•× ××—×•×¥ ×œ×¡×‘×™×‘×ª ×”-Sandbox ×”× ×•×›×—×™×ª (×›×œ×•××¨, ×”×¤×¢×œ ×©×¨×ª ××§×•××™ ×•×¤×ª×— ×‘×“×¤×“×¤×Ÿ ×”×¨××©×™).'
                    : '×”×”×ª×—×‘×¨×•×ª × ×›×©×œ×”: ' + error.message;

                alert(errorMessage);
                onDisconnected();
            }
        });

        function onConnected() {
            statusSpan.innerText = 'ğŸŸ¢ ××—×•×‘×¨!';
            statusSpan.classList.add('connected');
            connectBtn.disabled = true;
            connectBtn.innerText = '××—×•×‘×¨';
            runBtn.disabled = false;
        }

        function onDisconnected() {
            statusSpan.innerText = 'ğŸ”´ ×× ×•×ª×§';
            statusSpan.classList.remove('connected');
            connectBtn.disabled = false;
            connectBtn.innerText = 'ğŸ”Œ ×”×ª×—×‘×¨ ×œ-Micro:bit';
            runBtn.disabled = true;
            uartCharacteristic = null;
            bluetoothDevice = null;
        }

        // ==========================================
        // 4. ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×”×¨×¦×” (Runtime)
        // ==========================================

        // ×¤×•× ×§×¦×™×” ×©×©×•×œ×—×ª ×˜×§×¡×˜ ×œ××™×§×¨×•×‘×™×˜
        async function sendCommand(cmd) {
            if (!uartCharacteristic) {
                console.warn("×œ× ××—×•×‘×¨, ×”×¤×§×•×“×” ×œ× × ×©×œ×—×”:", cmd);
                return;
            }
            try {
                // ×”×•×¡×¤×ª ×ª×• ×™×¨×™×“×ª ×©×•×¨×” (\n) ×‘×¡×•×£ ×”×¤×§×•×“×” ×”×™× ×§×¨×™×˜×™×ª ×œ×¤×¨×•×˜×•×§×•×œ UART
                let encoder = new TextEncoder();
                await uartCharacteristic.writeValue(encoder.encode(cmd + "\n"));
                console.log("× ×©×œ×— ×œ××™×§×¨×•×‘×™×˜:", cmd);
            } catch (err) {
                console.error("×©×’×™××” ×‘×©×œ×™×—×”:", err);
            }
        }

        // ×¤×•× ×§×¦×™×™×ª ×”××ª× ×” (Promise based)
        function wait(seconds) {
            return new Promise(resolve => setTimeout(resolve, seconds * 1000));
        }

        // ==========================================
        // 5. ×”×¨×¦×ª ×”×§×•×“
        // ==========================================

        runBtn.addEventListener('click', () => {
            // ×™×¦×™×¨×ª ×§×•×“ JS ××”×‘×œ×•×§×™×
            const code = Blockly.JavaScript.workspaceToCode(workspace);
            
            // ×¢×•×˜×¤×™× ×‘×¤×•× ×§×¦×™×” ××¡×™× ×›×¨×•× ×™×ª ×›×“×™ ×œ××¤×©×¨ ×©×™××•×© ×‘-await (×œ×”××ª× ×•×ª)
            const asyncWrapper = `
            (async function() {
                try {
                    console.log("××ª×—×™×œ ×¨×™×¦×”...");
                    ${code}
                    console.log("×”×¨×™×¦×” ×”×¡×ª×™×™××”.");
                } catch (e) {
                    console.error("×©×’×™××” ×‘×–××Ÿ ×¨×™×¦×”:", e);
                    alert("×©×’×™××” ×‘×§×•×“: " + e.message);
                }
            })();
            `;

            console.log("×”×§×•×“ ×©× ×•×¦×¨:\n", asyncWrapper);
            
            // ×”×¨×¦×ª ×”×§×•×“ ×‘×¤×•×¢×œ
            try {
                eval(asyncWrapper); 
            } catch (e) {
                alert(e);
            }
        });

    </script>
</body>
</html>
