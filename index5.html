<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×™××•×œ×˜×•×¨ ×¦×‘ Web</title>
    <!-- ×˜×¢×™× ×ª Tailwind CSS ×•×¤×•× ×˜ Inter -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper.js for Carousel -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .character { transition: transform 0.3s ease-in-out; }

        /* Main Workbench Container */
        .workbench-container {
            background-color: #8B5A2B; /* Wood color */
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            border-radius: 2rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), inset 0 0 15px rgba(0,0,0,0.5);
            border: 4px solid #5a3d1d;
        }

        /* Game Grid - Planter Box Style */
        .planter-box-grid {
            background-size: cover;
            background-position: center;
            border: 12px solid #5a3d1d;
            border-radius: 1rem;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.6);
            transition: background-color 0.2s ease;
        }

        /* Control Panels - Parchment Style */
        .parchment-panel {
            background-color: #fdf5e6; /* Parchment color */
            border-radius: 1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 1px solid #d2b48c;
        }
        
        /* Wooden Buttons */
        .wooden-button {
            transition: all 0.1s ease;
            box-shadow: 0 4px #5a3d1d;
            border: 2px solid #5a3d1d;
        }
        .wooden-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #5a3d1d;
        }
        .wooden-button.round { border-radius: 9999px; }
        .wooden-button.rect { border-radius: 0.75rem; }

        .sequence-item-selected {
            box-shadow: 0 0 0 4px #fbbf24; /* Yellow ring */
            transform: scale(1.1);
        }

        /* Swiper Carousel Styles */
        .swiper-container {
            width: 100%;
            height: 100%;
        }
        .swiper-slide {
            width: auto !important; /* Crucial for slidesPerView: 'auto' */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .swiper-button-next, .swiper-button-prev {
            color: #5a3d1d !important;
            background-color: #d2b48c; /* Matching command buttons */
            border-radius: 50%;
            width: 36px !important;
            height: 36px !important;
            
            /* Styles from .wooden-button for consistency */
            transition: all 0.1s ease;
            box-shadow: 0 4px #5a3d1d;
            border: 2px solid #5a3d1d;

            /* Overrides for flexbox layout */
            position: static !important;
            margin-top: 0 !important;
        }
        .swiper-button-next:active, .swiper-button-prev:active {
            transform: translateY(2px);
            box-shadow: 0 2px #5a3d1d;
        }
        .swiper-button-next:after, .swiper-button-prev:after {
            font-size: 18px !important;
            font-weight: bold;
        }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-[#fdf5e6] p-2 sm:p-4 md:p-8">

    <div class="max-w-6xl mx-auto font-sans">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-[#4a2d19]">×¡×“× ×ª ×”×’×™× ×” ×©×œ ×”×¦×‘</h1>
            <p class="text-base sm:text-lg text-[#6b4226] mt-2">×‘× ×” ××œ×’×•×¨×™×ª× ×•×”×•×‘×™×œ ××ª ×”×¦×‘ ×œ×™×¢×“!</p>
        </header>
        
        <main class="workbench-container p-4 md:p-8">
             <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <!-- Level Selector -->
                <div class="parchment-panel p-4 flex-grow overflow-hidden">
                    <label class="block text-xl font-bold mb-3 text-[#5a3d1d] text-center">×‘×—×¨ ××ª×’×¨:</label>
                    <div class="flex items-center gap-2">
                        <div class="swiper-button-prev"></div>
                        <div id="levelSwiper" class="swiper-container flex-1 overflow-hidden">
                            <div class="swiper-wrapper" id="levelSelectorGrid">
                                <!-- Level slides will be rendered here -->
                            </div>
                        </div>
                        <div class="swiper-button-next"></div>
                    </div>
                </div>
                <!-- Score Panel -->
                <div class="parchment-panel p-4 flex flex-col items-center justify-center">
                    <div class="text-xl font-bold text-[#5a3d1d]">× ×™×§×•×“</div>
                    <div id="scoreDisplay" class="text-4xl font-bold text-green-700">0</div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-6 md:gap-8">
                
                <!-- Game Grid -->
                <div id="gridContainer" class="flex-grow">
                    <!-- The grid will be rendered here -->
                </div>

                <!-- Background Color Slider -->
                <div class="parchment-panel p-4 text-center">
                    <label for="bgColorSlider" class="block font-semibold mb-2 text-[#5a3d1d] md:hidden">×©× ×” ×’×•×•×Ÿ ×¨×§×¢ ×œ××©×—×§</label>
                    <div class="flex items-center gap-4 md:flex-col md:h-full md:justify-center md:gap-y-4">
                        <span class="font-bold text-green-800 md:order-first">×™×¨×•×§</span>
                        <input type="range" id="bgColorSlider" min="0" max="100" value="100" 
                               class="w-full h-2 bg-[#d2b48c] rounded-lg appearance-none cursor-pointer 
                                      md:w-2 md:h-64 md:[writing-mode:vertical-lr]" 
                               oninput="handleBackgroundColorChange(event)">
                        <span class="font-bold text-[#6b4226] md:order-last">×—×•×</span>
                    </div>
                </div>

                <!-- Controls and Sequence Panel -->
                <div class="md:w-2/5 lg:w-1/3 space-y-6 flex flex-col">
                    
                    <div class="parchment-panel p-4 flex-grow flex flex-col">
                        <!-- Command Pad -->
                        <div>
                            <h2 class="text-2xl font-bold mb-4 text-center text-[#5a3d1d]">×¤×§×•×“×•×ª</h2>
                            <div id="commandPad" class="grid grid-cols-3 gap-2 justify-items-center items-center">
                                <!-- D-Pad layout is rendered here by JS -->
                            </div>
                        </div>

                        <!-- Sequence Area -->
                        <div class="mt-6 flex-grow flex flex-col">
                            <h2 class="text-2xl font-bold mb-2 text-center text-[#5a3d1d]">×¨×¦×£ (××œ×’×•×¨×™×ª×)</h2>
                            <div id="sequenceAreaWrapper" class="flex-grow flex flex-col">
                                 <!-- Sequence content and action buttons will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Feedback Panel -->
                    <div id="feedback" class="parchment-panel p-4 text-center font-semibold text-lg text-[#5a3d1d] transition-all duration-300" aria-live="polite">
                        ×˜×•×¢×Ÿ...
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Number Pad -->
    <div id="numberPadModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden">
        <!-- Content is rendered dynamically by JS -->
    </div>

    <script type="module">
        // =================================================
        // 1. ×”×’×“×¨×•×ª ×•×§×‘×•×¢×™×
        // =================================================
        const CommandType = { Forward: 'Forward', Backward: 'Backward', TurnRight: 'TurnRight', TurnLeft: 'TurnLeft' };
        
        const LEVELS = [
            {
                id: 0, name: '×ª×¨×’×•×œ', isPractice: true, size: { rows: 6, cols: 6 }, startPosition: { x: 0, y: 5 }, startDirection: 'North', targetPositions: [{ x: 5, y: 5 }],
                obstacles: [ {x:1, y:0}, {x:1, y:1}, {x:1, y:2}, {x:1, y:3}, {x:1, y:4}, {x:4, y:1}, {x:4, y:2}, {x:4, y:3}, {x:4, y:4}, {x:4, y:5} ],
            },
            { id: 1, name: '××ª×’×¨ 1', isPractice: false, size: { rows: 5, cols: 5 }, startPosition: { x: 0, y: 0 }, startDirection: 'East', targetPositions: [{ x: 4, y: 0 }], obstacles: [], },
            { id: 2, name: '××ª×’×¨ 2', isPractice: false, size: { rows: 5, cols: 5 }, startPosition: { x: 0, y: 2 }, startDirection: 'East', targetPositions: [{ x: 4, y: 2 }], obstacles: [{x: 2, y: 2}], },
            { id: 3, name: '××ª×’×¨ 3', isPractice: false, size: { rows: 5, cols: 5 }, startPosition: { x: 2, y: 4 }, startDirection: 'North', targetPositions: [{ x: 4, y: 0 }], obstacles: [ {x: 0, y: 0}, {x: 0, y: 1}, {x: 0, y: 2}, {x: 1, y: 2}, {x: 2, y: 2}, {x: 4, y: 1} ], },
            { id: 4, name: '××ª×’×¨ 4', isPractice: false, size: { rows: 5, cols: 5 }, startPosition: { x: 0, y: 4 }, startDirection: 'North', targetPositions: [{ x: 4, y: 4 }], obstacles: [ {x:1, y:1}, {x:1, y:2}, {x:1, y:3}, {x:1, y:4}, {x:3, y:0}, {x:3, y:1}, {x:3, y:2}, {x:3, y:3} ], },
            {
                id: 5, name: '××ª×’×¨ 5', isPractice: false, size: { rows: 6, cols: 6 }, startPosition: { x: 0, y: 5 }, startDirection: 'North', targetPositions: [{ x: 5, y: 0 }], obstacles: [
                    {x:1, y:1}, {x:1, y:2}, {x:1, y:3}, {x:1, y:4}, {x:2, y:1}, {x:3, y:1}, {x:4, y:1},
                    {x:3, y:3}, {x:4, y:3}, {x:5, y:3}, {x:3, y:4}, {x:3, y:5},
                ]
            },
            {
                id: 6, name: '××ª×’×¨ 6', isPractice: false, size: { rows: 7, cols: 7 }, startPosition: { x: 6, y: 6 }, startDirection: 'West', targetPositions: [{ x: 0, y: 0 }], obstacles: [
                    {x:0, y:1}, {x:1, y:1}, {x:2, y:1}, {x:3, y:1}, {x:4, y:1}, {x:1, y:3}, {x:2, y:3}, 
                    {x:3, y:3}, {x:4, y:3}, {x:5, y:3}, {x:1, y:5}, {x:2, y:5}, {x:3, y:5}, {x:4, y:5}, {x:5, y:5},
                ]
            },
            // ALL LEVELS FROM 7 ONWARDS ARE NOW 8x8
            {
                id: 7, name: '××ª×’×¨ 7', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 0, y: 7 }, startDirection: 'North', targetPositions: [{ x: 7, y: 0 }], 
                obstacles: [
                    ...Array.from({length:7}, (v,i)=>({x:1, y:i+1})), // Wall with opening at y=0
                    ...Array.from({length:7}, (v,i)=>({x:3, y:i})),   // Wall with opening at y=7
                    ...Array.from({length:7}, (v,i)=>({x:5, y:i+1})), // Wall with opening at y=0
                ]
            },
            {
                id: 8, name: '××ª×’×¨ 8', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 0, y: 0 }, startDirection: 'East', targetPositions: [{ x: 4, y: 3 }],
                obstacles: [
                    ...Array.from({length: 6}, (v,i)=>({x:i+1, y:1})), 
                    ...Array.from({length: 5}, (v,i)=>({x:6, y:i+1})), 
                    ...Array.from({length: 6}, (v,i)=>({x:i, y:6})),   
                    ...Array.from({length: 4}, (v,i)=>({x:1, y:i+2})), 
                    ...Array.from({length: 3}, (v,i)=>({x:i+2, y:2})), 
                    ...Array.from({length: 2}, (v,i)=>({x:4, y:i+3})), 
                ]
            },
            {
                id: 9, name: '××ª×’×¨ 9', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 0, y: 7 }, startDirection: 'North', targetPositions: [{ x: 7, y: 0 }],
                obstacles: [
                    {x:1,y:1},{x:1,y:2},{x:2,y:1},{x:2,y:2},
                    {x:1,y:5},{x:1,y:6},{x:2,y:5},{x:2,y:6},
                    {x:5,y:1},{x:5,y:2},{x:6,y:1},{x:6,y:2},
                    {x:5,y:5},{x:5,y:6},{x:6,y:5},{x:6,y:6},
                ]
            },
            {
                id: 10, name: '××ª×’×¨ 10', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 0, y: 5 }, startDirection: 'East', targetPositions: [{ x: 7, y: 2 }],
                obstacles: [
                    ...Array.from({length: 5}, (v,i)=>({x:i+2, y:1})),
                    ...Array.from({length: 5}, (v,i)=>({x:i, y:3})),
                    ...Array.from({length: 5}, (v,i)=>({x:i+2, y:4})),
                    ...Array.from({length: 5}, (v,i)=>({x:i, y:6})),
                ]
            },
            {
                id: 11, name: '××ª×’×¨ 11', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 0, y: 0 }, startDirection: 'East',
                targetPositions: [{ x: 7, y: 0 }, { x: 7, y: 7 }],
                obstacles: [...Array.from({length: 8}, (v,i)=>({x:3, y:i})).filter(p => p.y !== 4)],
            },
            {
                id: 12, name: '××ª×’×¨ 12', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 4, y: 4 }, startDirection: 'North',
                targetPositions: [{ x: 0, y: 0 }, { x: 7, y: 7 }],
                obstacles: [
                    ...Array.from({length: 7}, (v,i)=>({x:i+1, y:2})),
                    ...Array.from({length: 7}, (v,i)=>({x:i, y:5})),
                ],
            },
            {
                id: 13, name: '××ª×’×¨ 13', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 0, y: 7 }, startDirection: 'North',
                targetPositions: [{ x: 4, y: 3 }, { x: 3, y: 4 }],
                obstacles: [
                    ...Array.from({length: 6}, (v,i)=>({x:i+1, y:6})),
                    ...Array.from({length: 5}, (v,i)=>({x:6, y:i+1})),
                    ...Array.from({length: 5}, (v,i)=>({x:i+1, y:1})),
                    ...Array.from({length: 3}, (v,i)=>({x:2, y:i+2})),
                ],
            },
            {
                id: 14, name: '××ª×’×¨ 14', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 0, y: 4 }, startDirection: 'East',
                targetPositions: [{ x: 2, y: 2 }, { x: 6, y: 6 }],
                obstacles: [
                    ...Array.from({length:8}, (v,i)=>({x:3, y:i})).filter(p => p.y !== 4),
                    ...Array.from({length:8}, (v,i)=>({x:5, y:i})).filter(p => p.y !== 4),
                ],
            },
            {
                id: 15, name: '××ª×’×¨ 15', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 0, y: 0 }, startDirection: 'East',
                targetPositions: [{ x: 7, y: 0 }, { x: 7, y: 7 }],
                obstacles: [
                    ...[1,3,5].flatMap(col => Array.from({length:8}, (_,row) => ({x: col, y: row})))
                        .filter(p => !(p.x===1 && p.y===4) && !(p.x===3 && p.y===1) && !(p.x===5 && p.y===6)),
                ],
            },
            {
                id: 16, name: '××ª×’×¨ 16', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 4, y: 4 }, startDirection: 'North',
                targetPositions: [{ x: 0, y: 0 }, { x: 7, y: 7 }],
                obstacles: [
                    ...Array.from({length: 7}, (v,i)=>({x: 1, y: i})),
                    ...Array.from({length: 7}, (v,i)=>({x: 3, y: i + 1})),
                    ...Array.from({length: 7}, (v,i)=>({x: 5, y: i})),
                ],
            },
            {
                id: 17, name: '××ª×’×¨ 17', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 0, y: 0 }, startDirection: 'East',
                targetPositions: [{ x: 7, y: 0 }, { x: 7, y: 7 }],
                obstacles: [1, 3, 5].flatMap(col => Array.from({length:8}, (v, row) => ({x: col, y: row})))
                    .filter(p => !(p.x === 1 && p.y === 4) && !(p.x === 3 && p.y === 2) && !(p.x === 5 && p.y === 6)),
            },
            {
                id: 18, name: '××ª×’×¨ 18', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 4, y: 0 }, startDirection: 'South',
                targetPositions: [{ x: 1, y: 7 }, { x: 6, y: 7 }],
                obstacles: [1, 3, 5].flatMap(row => Array.from({length:8}, (v, col) => ({x: col, y: row})))
                    .filter(p => !(p.y === 1 && p.x === 6) && !(p.y === 3 && p.x === 1) && !(p.y === 5 && p.x === 6)),
            },
            {
                id: 19, name: '××ª×’×¨ 19', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 1, y: 1 }, startDirection: 'East',
                targetPositions: [{ x: 6, y: 1 }, { x: 6, y: 6 }],
                obstacles: [
                    ...Array.from({length:8}, (v,i)=>({x:3, y:i})),
                    ...Array.from({length:8}, (v,i)=>({x:i, y:3})),
                ].filter(p => !(p.x === 3 && p.y === 1) && !(p.x === 1 && p.y === 3) && !(p.x === 3 && p.y === 6) && !(p.x === 6 && p.y === 3)),
            },
            {
                id: 20, name: '××ª×’×¨ 20', isPractice: false, size: { rows: 8, cols: 8 }, startPosition: { x: 0, y: 4 }, startDirection: 'East',
                targetPositions: [{ x: 7, y: 0 }, { x: 7, y: 7 }],
                obstacles: [2, 4, 6].flatMap(c => Array.from({length:8}, (v,r)=>({x:c, y:r}))).filter(p => {
                    if (p.x === 2) return p.y !== 1 && p.y !== 6;
                    if (p.x === 4) return p.y !== 3 && p.y !== 4;
                    if (p.x === 6) return p.y !== 2 && p.y !== 5;
                    return true;
                }),
            }
        ];
        const ROTATION_MAP = { 'North': 90, 'East': 180, 'South': 270, 'West': 0 };
        const REVERSE_ROTATION_MAP = { 90: 'North', 180: 'East', 270: 'South', 0: 'West' };

        const successSound = new Audio('https://codejredu.github.io/test/assets/sound/winner.mp3');

        // =================================================
        // 2. ××¦×‘ ×”××©×—×§ (State)
        // =================================================
        let state = {
            currentLevelId: 0,
            gridState: { size: { rows: 0, cols: 0 }, targetPositions: [], obstacles: new Set() },
            beeBotState: { position: { x: 0, y: 0 }, direction: 'East', rotation: 180 },
            sequence: [],
            selectedSequenceIndex: -1,
            executingIndex: -1,
            isExecuting: false,
            forwardSteps: 1, backwardSteps: 1, isNumberPadOpen: false, numberPadTarget: null,
            score: 0,
            maxLevelUnlocked: 1, // Start with level 1 unlocked
            visitedTargets: new Set(),
        };

        // UI state
        let swiperInstance = null;
        
        // Cheat code state
        let targetClickCount = 0;
        let lastTargetClickTime = 0;

        // =================================================
        // 3. ×œ×•×’×™×§×ª ×”××©×—×§
        // =================================================
        function applySingleStep(commandType, currentBeeState, currentGrid) {
            let { x, y } = { ...currentBeeState.position };
            let newRotation = currentBeeState.rotation;
            if (commandType === CommandType.TurnRight) newRotation = (newRotation + 90) % 360;
            else if (commandType === CommandType.TurnLeft) newRotation = (newRotation - 90 + 360) % 360;
            else {
                const baseStep = commandType === CommandType.Forward ? 1 : -1;
                switch (newRotation) {
                    case 180: x += baseStep; break; case 0: x -= baseStep; break;
                    case 90:  y -= baseStep; break; case 270: y += baseStep; break;
                }
            }
            const newState = { position: { x, y }, rotation: newRotation, direction: REVERSE_ROTATION_MAP[newRotation] };
            if (commandType.includes('Turn')) return { success: true, newState };
            if (x < 0 || x >= currentGrid.size.cols || y < 0 || y >= currentGrid.size.rows || currentGrid.obstacles.has(`${x},${y}`)) {
                return { success: false, newState: { ...currentBeeState } };
            }
            return { success: true, newState };
        }

        function loadLevel(levelId) {
            const level = LEVELS.find(l => l.id === levelId) || LEVELS[0];
            if (!level.isPractice && level.id > state.maxLevelUnlocked) { return; }

            if (level.isPractice) {
                state.score = 0;
            }

            const obsSet = new Set(level.obstacles.map(o => `${o.x},${o.y}`));
            state = { ...state, currentLevelId: levelId, gridState: { size: level.size, targetPositions: level.targetPositions, obstacles: obsSet }, beeBotState: { position: { ...level.startPosition }, direction: level.startDirection, rotation: ROTATION_MAP[level.startDirection] }, sequence: [], selectedSequenceIndex: -1, executingIndex: -1, isExecuting: false, forwardSteps: 1, backwardSteps: 1, visitedTargets: new Set() };
            setFeedback(`×©×œ×‘ '${level.name}' × ×˜×¢×Ÿ.`, 'info');
            renderAll();
        }
        
        function handleLevelCompletion() {
            try {
                successSound.currentTime = 0; // Rewind to start
                successSound.play();
            } catch(e) { console.warn("Could not play sound", e); }

            const currentLevel = LEVELS.find(l => l.id === state.currentLevelId);
            if (currentLevel.isPractice) {
                setFeedback("××¢×•×œ×”! ×¡×™×™××ª ××ª ×”×ª×¨×’×•×œ!", 'success');
                setTimeout(() => loadLevel(state.currentLevelId), 2000);
                return;
            }

            const points = currentLevel.id <= 5 ? 5 : (currentLevel.id <= 10 ? 10 : 15);
            state.score += points;

            if (currentLevel.id === state.maxLevelUnlocked) {
                 const totalLevels = LEVELS.filter(l => !l.isPractice).length;
                 if (state.maxLevelUnlocked < totalLevels) {
                    state.maxLevelUnlocked++;
                 }
            }
            setFeedback(`×”×¦×œ×—×ª! +${points} × ×§×•×“×•×ª!`, 'success');
            setTimeout(goToNextLevel, 2000);
        }

        function goToNextLevel() {
            const currentLevelIndex = LEVELS.findIndex(l => l.id === state.currentLevelId);
            const nextLevel = LEVELS[currentLevelIndex + 1];
            if (nextLevel && !nextLevel.isPractice) {
                loadLevel(nextLevel.id);
            } else {
                setFeedback("×›×œ ×”×›×‘×•×“! ×¡×™×™××ª ××ª ×›×œ ×”××ª×’×¨×™×! ğŸ‰", 'success');
                setTimeout(() => loadLevel(0), 3000);
            }
        }
        
        async function executeCommandList(commands, initialBeeState) {
            let currentState = { ...initialBeeState };
            let wasSuccessful = true;
            for (let i = 0; i < commands.length; i++) {
                if (state.executingIndex !== -1) { state.executingIndex = i; renderControls(); }
                const { type, steps = 1 } = commands[i];
                for (let j = 0; j < steps; j++) {
                    await new Promise(r => setTimeout(r, 400));
                    const result = applySingleStep(type, currentState, state.gridState);
                    if (!result.success) {
                        wasSuccessful = false;
                        setFeedback("××•×¤×¡! × ×ª×§×œ×ª ×‘×§×™×¨ ××• ××›×©×•×œ ğŸš§", 'error');
                        await new Promise(r => setTimeout(r, 1000)); break;
                    }
                    currentState = result.newState;
                    state.beeBotState = currentState;
                    
                    const currentPosStr = `${currentState.position.x},${currentState.position.y}`;
                    if (state.gridState.targetPositions.some(p => p.x === currentState.position.x && p.y === currentState.position.y)) {
                        state.visitedTargets.add(currentPosStr);
                    }
                    
                    renderGrid();
                }
                if (!wasSuccessful) break;
            }
            return { success: wasSuccessful, finalState: currentState };
        }

        // =================================================
        // 4. ×¨×™× ×“×•×¨ (UI)
        // =================================================
        function setFeedback(msg, type) {
            const el = document.getElementById('feedback');
            const styles = { info: "text-[#5a3d1d]", success: "text-green-700 font-bold", error: "text-red-700 font-bold", warning: "text-orange-600 font-bold" };
            el.innerHTML = msg; 
            el.className = `parchment-panel p-4 text-center font-semibold text-lg transition-all duration-300 ${styles[type]}`;
        }
        const getCharacterSVG = (rotation) => `<img src="https://codejredu.github.io/claudejr/turtle.svg" alt="×¦×‘" class="character absolute w-[90%] h-[90%] top-[5%] left-[5%] z-20" style="transform: rotate(${rotation - 90}deg);" />`;
        const getBushSVG = (x, y) => {
            const bushIndex = (x * 3 + y * 5) % 3;
            const bushes = [
                `<svg viewBox="0 0 100 100"><path d="M 20 80 C 10 80, 10 60, 25 60 S 40 40, 50 50 S 60 40, 75 60 S 90 80, 80 80 Z" fill="#65a30d"/><circle cx="30" cy="55" r="8" fill="#fb7185"/><circle cx="50" cy="45" r="10" fill="#f472b6"/><circle cx="70" cy="55" r="8" fill="#e879f9"/></svg>`,
                `<svg viewBox="0 0 100 100"><path d="M 20 80 Q 50 40, 80 80 Z" fill="#4d7c0f"/><path d="M 30 80 Q 50 60, 70 80 Z" fill="#65a30d"/><circle cx="35" cy="68" r="7" fill="#facc15"/><circle cx="50" cy="58" r="9" fill="#fbbf24"/><circle cx="65" cy="68" r="7" fill="#f59e0b"/></svg>`,
                `<svg viewBox="0 0 100 100"><path d="M 20 80 C 20 50, 80 50, 80 80 Z" fill="#166534"/><circle cx="30" cy="60" r="8" fill="#a78bfa"/><circle cx="50" cy="50" r="10" fill="#c084fc"/><circle cx="70" cy="60" r="8" fill="#d8b4fe"/></svg>`
            ];
            return `<div class="w-full h-full p-1 opacity-90">${bushes[bushIndex]}</div>`;
        };
        function renderLevelSelector() {
            const container = document.getElementById('levelSelectorGrid');
            container.innerHTML = LEVELS.map(level => {
                const isCurrent = level.id === state.currentLevelId;
                const isLocked = !level.isPractice && level.id > state.maxLevelUnlocked;
                const buttonText = level.isPractice ? '×ª×¨×’×•×œ' : (isLocked ? 'ğŸ”’' : level.id);
                const baseClasses = "w-14 h-14 flex items-center justify-center font-bold text-lg transition-colors shadow-md disabled:opacity-50 wooden-button rect";
                const activeClasses = "bg-green-600 text-white";
                const lockedClasses = "bg-gray-400 text-gray-700 cursor-not-allowed";
                const inactiveClasses = "bg-[#d2b48c] text-[#5a3d1d] hover:bg-[#c1a37c]";
                
                const buttonHTML = `<button onclick="handleLevelChange(${level.id})" class="${baseClasses} ${isCurrent ? activeClasses : (isLocked ? lockedClasses : inactiveClasses)}" ${isLocked || state.isExecuting ? 'disabled' : ''}>${buttonText}</button>`;
                return `<div class="swiper-slide">${buttonHTML}</div>`;
            }).join('');
            
            if (swiperInstance) {
                swiperInstance.update();
            } else {
                swiperInstance = new Swiper('#levelSwiper', {
                    slidesPerView: 'auto',
                    spaceBetween: 5,
                    centeredSlides: false,
                    loop: false,
                    navigation: {
                        nextEl: '.swiper-button-next',
                        prevEl: '.swiper-button-prev',
                    },
                });
            }
            const currentLevelIndex = LEVELS.findIndex(l => l.id === state.currentLevelId);
            if (currentLevelIndex > -1) {
                swiperInstance.slideTo(currentLevelIndex, 0);
            }
        }
        function renderGrid() {
            const container = document.getElementById('gridContainer');
            const { size, targetPositions, obstacles } = state.gridState;
            const cellsHTML = Array.from({ length: size.rows * size.cols }, (_, i) => {
                const y = Math.floor(i / size.cols), x = i % size.cols;
                const isTarget = targetPositions.some(p => p.x === x && p.y === y);
                const isVisited = state.visitedTargets.has(`${x},${y}`);
                const isObstacle = obstacles.has(`${x},${y}`);
                const isBeeHere = x === state.beeBotState.position.x && y === state.beeBotState.position.y;
                let content = '';
                if (isTarget) {
                    content = `<span class="text-4xl transition-opacity duration-300 ${isVisited ? 'opacity-40' : ''}" onclick="handleTargetClick()">ğŸ¯</span>`;
                } else if (isObstacle) {
                    content = getBushSVG(x, y);
                }
                if (isBeeHere) content += getCharacterSVG(state.beeBotState.rotation);
                const borderClass = 'border border-[var(--grid-border-color)]';
                const bgClass = isObstacle ? 'bg-green-900/30' : '';
                return `<div class="relative ${borderClass} ${bgClass} flex items-center justify-center">${content}</div>`;
            }).join('');
            container.innerHTML = `<div dir="ltr" id="gameGrid" class="planter-box-grid grid w-full max-w-[600px] aspect-square mx-auto p-2" style="grid-template-columns: repeat(${size.cols}, 1fr); grid-template-rows: repeat(${size.rows}, 1fr); background-color: var(--grid-bg-color, hsl(125, 50%, 85%)); --grid-border-color: var(--grid-border-color-val, hsl(125, 40%, 60%));">${cellsHTML}</div>`;
        }
        function renderScore() {
            document.getElementById('scoreDisplay').textContent = state.score;
        }
        const getCommandIcon = (cmdType) => ({ [CommandType.Forward]: `<img src="https://codejredu.github.io/test/assets/blocklyicon/fd.svg" alt="Forward" class="w-10 h-10">`, [CommandType.Backward]: `<img src="https://codejredu.github.io/test/assets/blocklyicon/bk.svg" alt="Backward" class="w-10 h-10">`, [CommandType.TurnRight]: `<img src="https://codejredu.github.io/test/assets/blocklyicon/rtbee.svg" alt="Turn Right" class="w-10 h-10">`, [CommandType.TurnLeft]: `<img src="https://codejredu.github.io/test/assets/blocklyicon/ltbee.svg" alt="Turn Left" class="w-10 h-10">` }[cmdType] || '?');
        function renderNumberPad() {
            const modal = document.getElementById('numberPadModal');
            if (!state.isNumberPadOpen) { modal.classList.add('hidden'); return; }
            modal.classList.remove('hidden');
            const numbersHTML = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(n => `<button onclick="selectNumber(${n})" class="w-14 h-14 text-xl font-bold bg-[#8B5A2B] text-white rounded-full wooden-button round">${n}</button>`).join('');
            modal.innerHTML = `<div class="bg-[#fdf5e6] p-6 rounded-2xl shadow-xl w-full max-w-sm text-center animate-fade-in-up parchment-panel"><h3 class="text-xl font-semibold mb-4 text-[#5a3d1d]">×‘×—×¨ ××¡×¤×¨ ×¦×¢×“×™×</h3><div class="grid grid-cols-5 gap-3 justify-items-center">${numbersHTML}</div><button onclick="closeNumberPad()" class="mt-6 bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400 wooden-button rect">×¡×’×•×¨</button></div>`;
        }
        function renderControls() {
            const commandPad = document.getElementById('commandPad');
            const sequenceWrapper = document.getElementById('sequenceAreaWrapper');
            
            const disabledAttr = state.isExecuting ? 'disabled' : '';
            const forwardIcon = getCommandIcon(CommandType.Forward);
            const backwardIcon = getCommandIcon(CommandType.Backward);
            const leftIcon = getCommandIcon(CommandType.TurnLeft);
            const rightIcon = getCommandIcon(CommandType.TurnRight);
            const forwardSteps = state.forwardSteps;
            const backwardSteps = state.backwardSteps;

            commandPad.innerHTML = `
                <!-- Row 1 -->
                <div></div>
                <div class="flex flex-col items-center gap-2">
                    <button onclick="handleCommand('${CommandType.Forward}')" ${disabledAttr} class="command-button wooden-button round bg-[#d2b48c] w-14 h-14 sm:w-16 sm:h-16 flex items-center justify-center disabled:opacity-50">${forwardIcon}</button>
                    <button onclick="openNumberPad('${CommandType.Forward}')" ${disabledAttr} class="w-14 h-7 sm:w-16 sm:h-8 text-center rounded-md border-2 border-[#8B5A2B] bg-white text-[#5a3d1d] font-bold text-lg disabled:opacity-50 wooden-button rect">${forwardSteps}</button>
                </div>
                <div></div>
                <!-- Row 2 -->
                <button onclick="handleCommand('${CommandType.TurnRight}')" ${disabledAttr} class="command-button wooden-button round bg-[#d2b48c] w-14 h-14 sm:w-16 sm:h-16 flex items-center justify-center disabled:opacity-50">${rightIcon}</button>
                <div></div>
                <button onclick="handleCommand('${CommandType.TurnLeft}')" ${disabledAttr} class="command-button wooden-button round bg-[#d2b48c] w-14 h-14 sm:w-16 sm:h-16 flex items-center justify-center disabled:opacity-50">${leftIcon}</button>
                <!-- Row 3 -->
                <div></div>
                <div class="flex flex-col items-center gap-2">
                    <button onclick="handleCommand('${CommandType.Backward}')" ${disabledAttr} class="command-button wooden-button round bg-[#d2b48c] w-14 h-14 sm:w-16 sm:h-16 flex items-center justify-center disabled:opacity-50">${backwardIcon}</button>
                    <button onclick="openNumberPad('${CommandType.Backward}')" ${disabledAttr} class="w-14 h-7 sm:w-16 sm:h-8 text-center rounded-md border-2 border-[#8B5A2B] bg-white text-[#5a3d1d] font-bold text-lg disabled:opacity-50 wooden-button rect">${backwardSteps}</button>
                </div>
                <div></div>
            `;

            const currentLevel = LEVELS.find(l => l.id === state.currentLevelId);
            let sequenceContentHTML = '';
            if (currentLevel.isPractice) {
                sequenceContentHTML = `<p class="w-full text-center text-gray-500 italic p-4">××¦×‘ ×ª×¨×’×•×œ: ×›×œ ×¤×§×•×“×” ××ª×‘×¦×¢×ª ××™×™×“×™×ª.</p>`;
            } else if (state.sequence.length === 0) {
                sequenceContentHTML = `<p class="w-full text-center text-gray-500 italic p-4">×”××œ×’×•×¨×™×ª× ×©×œ×š ×™×•×¤×™×¢ ×›××Ÿ...</p>`;
            } else {
                sequenceContentHTML = state.sequence.map((cmd, idx) => {
                    const icon = getCommandIcon(cmd.type);
                    const isTurn = cmd.type.includes('Turn');
                    return `<div onclick="selectSequenceItem(${idx})" class="relative flex items-center justify-center h-12 w-12 rounded-lg text-white font-bold transition-all cursor-pointer wooden-button rect bg-[#d2b48c] ${idx === state.selectedSequenceIndex ? 'sequence-item-selected' : ''} ${idx === state.executingIndex ? 'ring-4 ring-blue-500' : ''}">${icon}${!isTurn ? `<span class="absolute -top-2 -right-2 bg-white text-blue-700 text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center border-2 border-blue-500">${cmd.steps}</span>` : ''}</div>`;
                }).join('');
            }
            
            const deleteButtonHTML = state.selectedSequenceIndex !== -1 && !currentLevel.isPractice
                ? `<button onclick="deleteSelectedSequenceItem()" ${state.isExecuting ? 'disabled' : ''} class="w-full bg-orange-500 text-white p-3 font-bold text-lg wooden-button rect disabled:opacity-50">××—×§ ×¤×§×•×“×”</button>`
                : '';

            const runClearButtonsHTML = `<div class="flex gap-2">
                    <button onclick="runSequence()" ${(state.sequence.length === 0 || state.isExecuting) ? 'disabled' : ''} class="w-full bg-blue-600 text-white p-3 font-bold text-lg wooden-button rect disabled:opacity-50">×‘×¦×¢!</button>
                    <button onclick="handleClear()" ${state.isExecuting ? 'disabled' : ''} class="w-full bg-red-600 text-white p-3 font-bold text-lg wooden-button rect disabled:opacity-50">× ×§×”</button>
                </div>`;
            
            let actionButtonsHTML = '';
            if (currentLevel.isPractice) {
                actionButtonsHTML = `<button onclick="handleClear()" class="w-full bg-red-600 text-white p-3 font-bold text-lg wooden-button rect">××ª×—×œ</button>`;
            } else {
                actionButtonsHTML = `
                    <div class="flex gap-2">
                        ${state.selectedSequenceIndex !== -1 ? `<div class="flex-1">${deleteButtonHTML}</div>` : ''}
                        <div class="flex-1">${runClearButtonsHTML}</div>
                    </div>
                `;
            }

            sequenceWrapper.innerHTML = `<div class="min-h-[80px] max-h-40 overflow-y-auto flex-grow flex flex-wrap content-start justify-start gap-2 p-2 border-2 border-dashed border-[#c1a37c] rounded-lg bg-[#fdf5e6]/50">${sequenceContentHTML}</div><div class="mt-4 space-y-2">${actionButtonsHTML}</div>`;
        }

        function renderAll() { renderGrid(); renderControls(); renderLevelSelector(); renderNumberPad(); renderScore(); }

        // =================================================
        // 5. ××™× ×˜×¨××§×¦×™×” (Handlers)
        // =================================================
        window.handleBackgroundColorChange = (event) => {
            const value = event.target.value; // 0 (brown) to 100 (green)
            const brownHue = 30;
            const greenHue = 125;
            const hue = brownHue + ((greenHue - brownHue) * value / 100);
            
            const bgColor = `hsl(${hue}, 50%, 85%)`;
            const borderColor = `hsl(${hue}, 40%, 60%)`;

            const gridEl = document.getElementById('gameGrid');
            if (gridEl) {
                gridEl.style.setProperty('--grid-bg-color', bgColor);
                gridEl.style.setProperty('--grid-border-color-val', borderColor);
            }
        };
        window.handleTargetClick = () => {
            const now = Date.now();
            if (now - lastTargetClickTime > 2000) {
                targetClickCount = 1;
            } else {
                targetClickCount++;
            }
            lastTargetClickTime = now;

            if (targetClickCount >= 5) {
                const totalLevels = LEVELS.filter(l => !l.isPractice).length;
                if (state.maxLevelUnlocked < totalLevels) {
                    state.maxLevelUnlocked = totalLevels;
                    setFeedback("âœ¨ ×›×œ ×”×©×œ×‘×™× ×¤×ª×•×—×™×! âœ¨", 'success');
                    renderLevelSelector();
                } else {
                    setFeedback("×›×œ ×”×©×œ×‘×™× ×›×‘×¨ ×¤×ª×•×—×™×.", 'info');
                }
                targetClickCount = 0;
            } else if (targetClickCount < 5){
                setFeedback(`×œ×—×™×¦×” ${targetClickCount} ××ª×•×š 5 ×œ×¤×ª×™×—×ª ×©×œ×‘×™×...`, 'info');
            }
        };
        window.selectSequenceItem = (index) => { if (!state.isExecuting) { state.selectedSequenceIndex = state.selectedSequenceIndex === index ? -1 : index; renderControls(); } };
        window.deleteSelectedSequenceItem = () => { if (!state.isExecuting && state.selectedSequenceIndex > -1) { state.sequence.splice(state.selectedSequenceIndex, 1); state.selectedSequenceIndex = -1; renderControls(); } };
        window.openNumberPad = (type) => { if (!state.isExecuting) { state.isNumberPadOpen = true; state.numberPadTarget = type; renderNumberPad(); } };
        window.closeNumberPad = () => { state.isNumberPadOpen = false; renderNumberPad(); };
        window.selectNumber = (num) => { if (state.numberPadTarget === CommandType.Forward) state.forwardSteps = num; else state.backwardSteps = num; closeNumberPad(); renderControls(); };
        window.handleLevelChange = (id) => { if (!state.isExecuting) loadLevel(id); };
        window.handleCommand = async (type) => {
            if (state.isExecuting) return;
            state.selectedSequenceIndex = -1;
            const isMovement = type === CommandType.Forward || type === CommandType.Backward;
            const steps = isMovement ? (type === CommandType.Forward ? state.forwardSteps : state.backwardSteps) : 1;
            const command = { type, steps };
            if (LEVELS.find(l => l.id === state.currentLevelId).isPractice) {
                state.isExecuting = true; renderAll();
                const result = await executeCommandList([command], state.beeBotState);
                const allTargetsReached = result.success && state.visitedTargets.size === state.gridState.targetPositions.length;
                if (allTargetsReached) {
                    handleLevelCompletion();
                } else {
                    state.isExecuting = false;
                    if (result.success) setFeedback(`×‘×•×¦×¢.`, 'info');
                    renderAll();
                }
            } else { state.sequence.push(command); renderControls(); }
        };
        window.handleClear = () => { if (!state.isExecuting) loadLevel(state.currentLevelId); };
        window.runSequence = async () => {
            const level = LEVELS.find(l => l.id === state.currentLevelId);
            if (state.isExecuting || level.isPractice || state.sequence.length === 0) return;
            
            state.selectedSequenceIndex = -1; 
            state.isExecuting = true;
            state.visitedTargets.clear();
            renderAll();

            const initialBeeState = { position: { ...level.startPosition }, rotation: ROTATION_MAP[level.startDirection] };
            state.beeBotState = initialBeeState; 
            renderGrid();

            setFeedback("××‘×¦×¢ ××ª ×”××œ×’×•×¨×™×ª×...", 'info');
            await new Promise(r => setTimeout(r, 500));
            const result = await executeCommandList(state.sequence, initialBeeState);
            state.executingIndex = -1;
            
            const allTargetsReached = result.success && state.visitedTargets.size === state.gridState.targetPositions.length;

            if (allTargetsReached) {
                handleLevelCompletion();
            } else {
                if (result.success) setFeedback("×”××œ×’×•×¨×™×ª× ×”×¡×ª×™×™×, ××š ×œ× ×”×’×¢×ª ×œ×›×œ ×”×™×¢×“×™×.", 'warning');
                state.isExecuting = false;
                renderAll();
            }
        };

        // =================================================
        // 6. ××ª×—×•×œ
        // =================================================
        window.onload = () => {
            loadLevel(state.currentLevelId);
            const initialSliderValue = document.getElementById('bgColorSlider').value;
            handleBackgroundColorChange({ target: { value: initialSliderValue } });
        };

    </script>
</body>
</html>
